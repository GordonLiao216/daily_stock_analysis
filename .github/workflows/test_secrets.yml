name: 🛠️ Secrets Configuration Checker

on:
  workflow_dispatch: # 只允许手动触发，保护隐私

jobs:
  check-env:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Validate Secrets and Variables
        env:
          # 列出所有你认为必须配置的变量
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          STOCK_LIST: ${{ vars.STOCK_LIST || secrets.STOCK_LIST }}
          # 可以在下方继续添加需要检查的变量...
        run: |
          echo "============================================="
          echo "🔍 开始检查 GitHub 环境变量配置情况"
          echo "============================================="
          
          error_found=0

          check_var() {
            local var_name=$1
            local var_value=$2
            if [ -z "$var_value" ]; then
              echo "❌ $var_name: 未配置 (Missing)"
              error_found=1
            else
              # 计算长度，确保密钥不是空的或只有空格
              length=${#var_value}
              echo "✅ $var_name: 已配置 (长度: $length)"
            fi
          }

          # 执行检查项
          check_var "GEMINI_API_KEY" "$GEMINI_API_KEY"
          check_var "TUSHARE_TOKEN" "$TUSHARE_TOKEN"
          check_var "PUSHPLUS_TOKEN" "$PUSHPLUS_TOKEN"
          check_var "STOCK_LIST" "$STOCK_LIST"

          echo "============================================="
          if [ $error_found -eq 1 ]; then
            echo "⚠️ 部分关键变量缺失，请检查仓库 Settings -> Secrets！"
            exit 1
          else
            echo "🎉 所有必要变量已就绪，可以运行分析脚本。"
          fi
